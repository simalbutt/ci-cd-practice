name: CI Pipeline  #name of pipeline appear on github actions tab

on:  #this is the trigger points 
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:  #list of jobs
  test:   
    runs-on: ubuntu-latest   #test will run on ubuntu

    steps:  #Defines a sequence of tasks that will be executed one after another within the test job.
      - name: Checkout code   
        uses: actions/checkout@v4  #Uses the official checkout action to download a copy of the 
        #repository code onto the runner VM. The @v4 specifies version 4 of the action.

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage



#Add Docker Build (Continuous Delivery Prep)
  build_and_push:
    runs-on: ubuntu-latest
    needs: test  # run after tests pass

    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        # with:
        #   registry: ghcr.io
        #   username: ${{ github.actor }}
        #   password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/ci-cd-practice:${{ github.sha }}
          docker build -t $IMAGE .
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Push Docker image
        run: docker push ${{ env.IMAGE }}

      - name: Upload image tag as artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: ${{ github.sha }}

#Simulate Staging Deployment
  deploy_staging:
    runs-on: ubuntu-latest
    needs: build_and_push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: Simulate Deploy
        run: |
          echo "Deploying image ${{ env.IMAGE }} to staging..."
          sleep 5
          echo "âœ… Deployment simulated successfully"

#rollback logic 
  rollback:
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Rollback
        run: echo "Rolling back to previous version..."

